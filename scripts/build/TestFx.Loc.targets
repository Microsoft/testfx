<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- Languages supported. -->
  <ItemGroup>
    <ResxLang Include="cs;de;es;fr;it;ja;ko;pl;pt-BR;ru;tr;zh-Hans;zh-Hant" />
  </ItemGroup>

  <!-- Default Localization folder. -->
  <PropertyGroup>
    <ResourceDirectory>$(ProjectDir)Resources</ResourceDirectory>
  </PropertyGroup>

  <Target Name="GatherResxResources">
    <ItemGroup>
      <ResxResources Include="@(EmbeddedResource)" Condition="%(Extension) == '.resx'" />
    </ItemGroup>
  </Target>

  <!-- Localization for Libraries.-->
  <Target Name="TestFxLocalization" Condition="$(IsVsixProj) =='' and $(IsVsixProj) !='true'" BeforeTargets="BeforeBuild" DependsOnTargets="GatherResxResources">
    <CallTarget Targets="CreateLocalizeXLF;CreateLocalizeResx" Condition="@(ResxResources) != ''"/>
  </Target>

  <Target Name="CreateLocalizeXLF" Condition="'$(UpdateXlf)' == 'true'">
    <CreateItem Include="@(ResxResources)" AdditionalMetadata="Language=%(ResxLang.Identity)">
      <Output ItemName="LocResourceFile" TaskParameter="Include"/>
    </CreateItem>
    <Exec Command="$(TestFxPackagesRoot)fmdev.xlftool\0.1.3\tools\xlftool.exe update -Resx %(LocResourceFile.Identity) -Xlf $(ResourceDirectory)\xlf\%(LocResourceFile.Filename).%(LocResourceFile.Language).xlf" />
    <Exec Command="$(TestFxPackagesRoot)fmdev.xlftool\0.1.3\tools\xlftool.exe update -Resx %(ResxResources.Identity) -Xlf $(ResourceDirectory)\xlf\%(ResxResources.Filename).xlf" />
  </Target>

  <Target Name="CreateLocalizeResx" Condition="'$(IsLocalizedBuild)' == 'true'">
    <CreateItem Include="@(ResxResources)" AdditionalMetadata="Language=%(ResxLang.Identity)">
      <Output ItemName="LocResourceFile" TaskParameter="Include"/>
    </CreateItem>
    <Exec Command="$(TestFxPackagesRoot)fmdev.xlftool\0.1.3\tools\xlftool.exe  writeTarget -Xlf $(ResourceDirectory)\xlf\%(LocResourceFile.Filename).%(LocResourceFile.Language).xlf -Resx $(ResourceDirectory)\%(LocResourceFile.Filename).%(LocResourceFile.Language).resx -verbose" />
    <ItemGroup>
      <EmbeddedResource Include="$(ResourceDirectory)\%(LocResourceFile.Filename).%(LocResourceFile.Language).resx" />
    </ItemGroup>
  </Target>

  <!-- Localization for vsix files.-->
  <!-- Forcing the Localize task and the localized vsixlangpack inclusion to run before the vsix package is created. 
Without this the vsix gets generated before localization and hence does not include localized assets. This is a workaround for an issue in the build system. -->
  <Target Name="PostLocalizeCopyArtifacts" DependsOnTargets="Localize" BeforeTargets="ZipProjects" Condition="'$(IsVsixProj)'=='true'">
    <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Release|AnyCPU' ">
      <LocalizationPath>$(OutputPath)\localize</LocalizationPath>
    </PropertyGroup>
    <ItemGroup>
        <Content Include="$(LocalizationPath)\CHS\extension.vsixlangpack" Condition="Exists('$(LocalizationPath)\CHS\extension.vsixlangpack')">
          <Link>zh-Hans\extension.vsixlangpack</Link>
          <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
          <IncludeInVSIX>true</IncludeInVSIX>
        </Content>
        <Content Include="$(LocalizationPath)\CHT\extension.vsixlangpack" Condition="Exists('$(LocalizationPath)\CHT\extension.vsixlangpack')">
          <Link>zh-Hant\extension.vsixlangpack</Link>
          <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
          <IncludeInVSIX>true</IncludeInVSIX>
        </Content>
        <Content Include="$(LocalizationPath)\csy\extension.vsixlangpack" Condition="Exists('$(LocalizationPath)\csy\extension.vsixlangpack')">
          <Link>cs\extension.vsixlangpack</Link>
          <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
          <IncludeInVSIX>true</IncludeInVSIX>
        </Content>
        <Content Include="$(LocalizationPath)\deu\extension.vsixlangpack" Condition="Exists('$(LocalizationPath)\deu\extension.vsixlangpack')">
          <Link>de\extension.vsixlangpack</Link>
          <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
          <IncludeInVSIX>true</IncludeInVSIX>
        </Content>
        <Content Include="$(LocalizationPath)\esn\extension.vsixlangpack" Condition="Exists('$(LocalizationPath)\esn\extension.vsixlangpack')">
          <Link>es\extension.vsixlangpack</Link>
          <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
          <IncludeInVSIX>true</IncludeInVSIX>
        </Content>
        <Content Include="$(LocalizationPath)\fra\extension.vsixlangpack" Condition="Exists('$(LocalizationPath)\fra\extension.vsixlangpack')">
          <Link>fr\extension.vsixlangpack</Link>
          <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
          <IncludeInVSIX>true</IncludeInVSIX>
        </Content>
        <Content Include="$(LocalizationPath)\ita\extension.vsixlangpack" Condition="Exists('$(LocalizationPath)\ita\extension.vsixlangpack')">
          <Link>it\extension.vsixlangpack</Link>
          <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
          <IncludeInVSIX>true</IncludeInVSIX>
        </Content>
        <Content Include="$(LocalizationPath)\jpn\extension.vsixlangpack" Condition="Exists('$(LocalizationPath)\jpn\extension.vsixlangpack')">
          <Link>ja\extension.vsixlangpack</Link>
          <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
          <IncludeInVSIX>true</IncludeInVSIX>
        </Content>
        <Content Include="$(LocalizationPath)\kor\extension.vsixlangpack" Condition="Exists('$(LocalizationPath)\kor\extension.vsixlangpack')">
          <Link>ko\extension.vsixlangpack</Link>
          <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
          <IncludeInVSIX>true</IncludeInVSIX>
        </Content>
        <Content Include="$(LocalizationPath)\plk\extension.vsixlangpack" Condition="Exists('$(LocalizationPath)\plk\extension.vsixlangpack')">
          <Link>pl\extension.vsixlangpack</Link>
          <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
          <IncludeInVSIX>true</IncludeInVSIX>
        </Content>
        <Content Include="$(LocalizationPath)\ptb\extension.vsixlangpack" Condition="Exists('$(LocalizationPath)\ptb\extension.vsixlangpack')">
          <Link>pt-BR\extension.vsixlangpack</Link>
          <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
          <IncludeInVSIX>true</IncludeInVSIX>
        </Content>
        <Content Include="$(LocalizationPath)\rus\extension.vsixlangpack" Condition="Exists('$(LocalizationPath)\rus\extension.vsixlangpack')">
          <Link>ru\extension.vsixlangpack</Link>
          <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
          <IncludeInVSIX>true</IncludeInVSIX>
        </Content>
        <Content Include="$(LocalizationPath)\trk\extension.vsixlangpack" Condition="Exists('$(LocalizationPath)\trk\extension.vsixlangpack')">
          <Link>tr\extension.vsixlangpack</Link>
          <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
          <IncludeInVSIX>true</IncludeInVSIX>
        </Content>
      </ItemGroup>
    </Target>
</Project>
