<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="$(MSBuildExtensionsPath32)\Microsoft\Portable\$(TargetFrameworkVersion)\Microsoft.Portable.CSharp.targets" Condition="$(TargetFrameworkProfile) == 'Profile259'" />
  <Import Project="$(MSBuildExtensionsPath)\Microsoft\WindowsXaml\v$(VisualStudioVersion)\Microsoft.Windows.UI.Xaml.CSharp.targets" Condition="$(TargetPlatformIdentifier) == 'UAP'" />
  <Import Project="$(MSBuildToolsPath)\Microsoft.CSharp.targets" Condition="($(TargetFrameworkProfile) == '' or $(TargetFrameworkProfile) != 'Profile259') and $(TargetPlatformIdentifier) != 'UAP'"/>
  
  <!-- Import props/targets with $(RepoRoot) since msbuild takes the relative path based on settings.targets and not with respect to the project. -->
  <Import Project="$(RepoRoot)packages\MicroBuild.Core.0.2.0\build\MicroBuild.Core.targets" Condition="Exists('$(RepoRoot)packages\MicroBuild.Core.0.2.0\build\MicroBuild.Core.targets')" />

  <PropertyGroup>
    <TestFxRoot Condition="$(TestFxRoot) == ''">..\..\</TestFxRoot>
    <TestFxPackagesRoot>$(TestFxRoot)packages\</TestFxPackagesRoot>
  </PropertyGroup>

  <ItemGroup>
    <None Include="$(TestFxRoot)scripts\build\key.snk">
      <!-- Do not have this show up in Solution Explorer in VS -->
      <InProject>false</InProject>
    </None>
  </ItemGroup>

  <!-- StyleCop settings. -->
  <ItemGroup Condition="$(ShouldEnableStyleCop) != 'false' and $(IsVsixProj) != 'true'">
    <AdditionalFiles Include="$(TestFxRoot)scripts\build\stylecop.json">
      <Link>stylecop.json</Link>
    </AdditionalFiles>
    
    <Analyzer Include="$(TestFxPackagesRoot)StyleCop.Analyzers.1.0.0\analyzers\dotnet\cs\Newtonsoft.Json.dll" />
    <Analyzer Include="$(TestFxPackagesRoot)StyleCop.Analyzers.1.0.0\analyzers\dotnet\cs\StyleCop.Analyzers.CodeFixes.dll" />
    <Analyzer Include="$(TestFxPackagesRoot)StyleCop.Analyzers.1.0.0\analyzers\dotnet\cs\StyleCop.Analyzers.dll" />
  </ItemGroup>

   <!-- Localization -->
  <ItemGroup>
    <ResxLang Include="cs;de;es;fr;it;ja;ko;pl;pt-BR;ru;tr;zh-Hans;zh-Hant" />
  </ItemGroup>

  <PropertyGroup>
    <ResourceDirectory>$(ProjectDir)Resources</ResourceDirectory>
  </PropertyGroup>  

  <!-- Signing and Localization. -->
  <ItemGroup Condition="$(IsTest) == '' or $(IsTest) == 'false'">
    <FilesToSign Include="$(OutDir)\$(AssemblyName).dll" Condition="'$(IsVsixProj)' == '' or '$(IsVsixProj)' != 'true'">
      <Authenticode>Microsoft</Authenticode>
      <StrongName>StrongName</StrongName>
    </FilesToSign>

    <FilesToSign Include="$(OutDir)\$(AssemblyName).vsix" Condition="'$(IsVsixProj)' == 'true'">
      <Authenticode>VsixSHA2</Authenticode>
    </FilesToSign>

    <FilesToLocalize Include="$(OutDir)\$(AssemblyName).dll" Condition="'$(AssemblyLclSubPath)' != ''">
      <TranslationFile>$(LclRoot)\{Lang}\$(AssemblyLclSubPath)\$(AssemblyName).dll.lcl</TranslationFile>
      <HasLceComments>false</HasLceComments>
    </FilesToLocalize>
    
    <SignFilesDependsOn Include="GatherLocalizedOutputsForSigning" Condition="'$(AssemblyLclSubPath)' != ''">
      <!-- Do not have this show up in Solution Explorer in VS -->
      <InProject>false</InProject>
    </SignFilesDependsOn>

	  <FilesToLocalize Include="$(OutDir)\$(AssemblyName).XML" Condition="'$(DocumentationLclSubPath)' != ''">
      <Languages>$(VS)</Languages>
      <ProjectFile>$(MSBuildThisFileFullPath)</ProjectFile>
      <Parser>210</Parser>
      <SettingsFile>$(LSBuildRoot)\locxml_teamarch.lss</SettingsFile>
      <LciCommentFile>$(LciRoot)\$(DocumentationLclSubPath)\$(AssemblyName).XML.lci</LciCommentFile>
      <TranslationFile>$(LclRoot)\{Lang}\$(DocumentationLclSubPath)\$(AssemblyName).XML.lcl</TranslationFile>
    </FilesToLocalize>

    <FilesToLocalize Include="$(OutDir)\extension.vsixlangpack" Condition="'$(VsixLclSubPath)' != ''">
      <Languages>$(VS)</Languages>
      <ProjectFile>$(MSBuildThisFileFullPath)</ProjectFile>
      <Parser>210</Parser>
      <SettingsFile>$(LSBuildRoot)\locxml_teamarch.lss</SettingsFile>
      <LciCommentFile>$(LciRoot)\$(VsixLclSubPath)\extension.vsixlangpack.lci </LciCommentFile>
      <TranslationFile>$(LclRoot)\{Lang}\$(VsixLclSubPath)\extension.vsixlangpack.lcl</TranslationFile>
    </FilesToLocalize>
  </ItemGroup>

  <!-- Localization -->
  <Target Name="BeforeBuild" Condition="$(TestProject) =='' and $(TestProject) !='true' and @(EmbeddedResource) != ''">
    <CallTarget Targets="CreateLocalizeXLF;CreateLocalizeResx"/>
  </Target>

  <Target Name="CreateLocalizeXLF" Condition="'$(UpdateXlf)' == 'true'">
    <CreateItem Include="@(EmbeddedResource)" AdditionalMetadata="Language=%(ResxLang.Identity)">
      <Output ItemName="LocResourceFile" TaskParameter="Include"/>
    </CreateItem>
    <Exec Command="$(TestFxPackagesRoot)fmdev.xlftool\0.1.3\tools\xlftool.exe update -Resx %(LocResourceFile.Identity) -Xlf $(ResourceDirectory)\xlf\%(LocResourceFile.Filename).%(LocResourceFile.Language).xlf" />
    <Exec Command="$(TestFxPackagesRoot)fmdev.xlftool\0.1.3\tools\xlftool.exe update -Resx %(EmbeddedResource.Identity) -Xlf $(ResourceDirectory)\xlf\%(EmbeddedResource.Filename).xlf" />
  </Target>

  <Target Name="CreateLocalizeResx" Condition="'$(IsLocalizedBuild)' == 'true'">
    <CreateItem Include="@(EmbeddedResource)" AdditionalMetadata="Language=%(ResxLang.Identity)">
      <Output ItemName="LocResourceFile" TaskParameter="Include"/>
    </CreateItem>
    <Exec Command="$(TestFxPackagesRoot)fmdev.xlftool\0.1.3\tools\xlftool.exe  writeTarget -Xlf $(ResourceDirectory)\xlf\%(LocResourceFile.Filename).%(LocResourceFile.Language).xlf -Resx $(ResourceDirectory)\%(LocResourceFile.Filename).%(LocResourceFile.Language).resx -verbose" />
    <ItemGroup>
      <EmbeddedResource Include="$(ResourceDirectory)\%(LocResourceFile.Filename).%(LocResourceFile.Language).resx" />
    </ItemGroup>
  </Target>

  <Target Name="EnsureNuGetPackageBuildImports" BeforeTargets="PrepareForBuild">
    <PropertyGroup>
      <ErrorText>This project references NuGet package(s) that are missing on this computer. Use NuGet Package Restore to download them.  For more information, see http://go.microsoft.com/fwlink/?LinkID=322105. The missing file is {0}.</ErrorText>
    </PropertyGroup>
    <Error Condition="!Exists('$(TestFxPackagesRoot)MicroBuild.Core.0.2.0\build\MicroBuild.Core.props')" Text="$([System.String]::Format('$(ErrorText)', '$(TestFxPackagesRoot)MicroBuild.Core.0.2.0\build\MicroBuild.Core.props'))" />
    <Error Condition="!Exists('$(TestFxPackagesRoot)MicroBuild.Core.0.2.0\build\MicroBuild.Core.targets')" Text="$([System.String]::Format('$(ErrorText)', '$(TestFxPackagesRoot)MicroBuild.Core.0.2.0\build\MicroBuild.Core.targets'))" />
  </Target>

  <Target Name="GatherLocalizedOutputsForSigning">
    <ItemGroup>
      <FilesToSign Include="$(OutDir)\localize\**\$(AssemblyName).resources.dll">
        <Authenticode>Microsoft</Authenticode>
        <StrongName>StrongName</StrongName>
      </FilesToSign>
    </ItemGroup>
  </Target>

  <!-- Generate AssemblyInfo.cs -->
  <PropertyGroup>
    <BuildNumber Condition=" '$(BuildNumber)' == '' ">0.1</BuildNumber>
    <MajorVersion>14.0</MajorVersion>
    <AssemblyVersion>$(MajorVersion).0.0</AssemblyVersion>
    <BuildVersion>$(MajorVersion).$(BuildNumber)</BuildVersion>
  </PropertyGroup>
  <ItemGroup>
    <AssemblyVersionAttribute Include="System.Reflection.AssemblyVersionAttribute">
      <_Parameter1>$(AssemblyVersion)</_Parameter1>
    </AssemblyVersionAttribute>
    <AssemblyVersionAttribute Include="System.Reflection.AssemblyFileVersionAttribute">
      <_Parameter1>$(BuildVersion)</_Parameter1>
    </AssemblyVersionAttribute>
    <AssemblyVersionAttribute Include="System.Reflection.AssemblyInformationalVersionAttribute">
      <_Parameter1>$(BuildVersion)</_Parameter1>
    </AssemblyVersionAttribute>
  </ItemGroup>
  <Target Name="GenerateAssemblyInfoFile">
    <WriteCodeFragment AssemblyAttributes="@(AssemblyVersionAttribute)" Language="C#" OutputFile="$(MSBuildProjectDirectory)\GlobalAssemblyInfo.cs">
      <Output TaskParameter="OutputFile" ItemName="Compile" />
      <Output TaskParameter="OutputFile" ItemName="FileWrites" />
    </WriteCodeFragment>
  </Target>
  <PropertyGroup>
    <CompileDependsOn>GenerateAssemblyInfoFile;$(CompileDependsOn)</CompileDependsOn>
  </PropertyGroup>
</Project>
